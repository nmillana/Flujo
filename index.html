<!-- ‚úÖ COPIA/PEGA ESTO EN TU HTML (YA TE DEJO TODO EL ARCHIVO COMPLETO) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagrama de Flujo - RRHH y N√≥mina (Editable)</title>

  <!-- Export PNG/PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 20px; }
    h1 { text-align: center; color: #333; margin-bottom: 10px; }
    .hint { text-align:center; color:#666; font-size: 0.9em; margin: 0 0 20px; }

    #captureArea{ width:max-content; }
    .flow-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }

    .macro {
      width: max-content;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      flex: 0 0 auto;
    }
    .macro[draggable="true"]{ cursor: grab; }
    .macro.dragging{ opacity: 0.6; transform: scale(0.995); }

    .macro-topbar{
      display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;
      margin: -2px 0 10px;
    }

    .macro-title {
      font-weight: bold; text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 12px;
      color: white; text-transform: uppercase; font-size: 0.9em;
    }
    .macro-desc{ text-align:center; color:#555; font-size: 0.85em; margin: 0 0 12px; max-width: 1300px; }

    .macro-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin: 8px 0 15px; }
    .btn {
      border: 1px solid rgba(0,0,0,0.15);
      background: #fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 0.82em;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      white-space: nowrap;
    }
    .btn:hover { background:#f9f9f9; }
    .danger { border-color: rgba(220,38,38,0.25); color:#b91c1c; }
    .primary { border-color: rgba(37,99,235,0.3); color:#1d4ed8; }

    .toolbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin: 0 0 18px; }
    .toolbar input{
      width: min(520px, 92vw);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      outline: none;
      background: #fff;
    }

    .subflow { display:flex; gap: 14px; overflow-x:auto; padding-bottom: 10px; align-items:flex-start; width: max-content; }
    .subflow::-webkit-scrollbar{height:10px}
    .subflow::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:999px}
    .subflow::-webkit-scrollbar-track{background:rgba(0,0,0,.06);border-radius:999px}

    .subblock { width: max-content; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); flex: 0 0 auto; }
    .subblock-title { font-weight: bold; text-align: center; padding: 9px; border-radius: 5px; margin-bottom: 10px; color: white; text-transform: uppercase; font-size: 0.82em; }

    .subblock[draggable="true"]{ cursor: grab; }
    .subblock.dragging{ opacity: 0.6; transform: scale(0.995); }
    .drag-handle{
      display:inline-flex; align-items:center; justify-content:center;
      width: 28px; height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.75);
      cursor: grab;
      user-select:none;
      font-size: 14px;
    }
    .subblock-topbar{
      display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;
      margin: -2px 0 10px;
    }

    .process-box {
      background: white;
      border: 1px solid #ddd;
      border-left: 6px solid #ddd;
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 12px;
      min-width: 260px;
      position: relative;
    }
    .process-title {
      font-weight: bold; font-size: 0.85em; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; color: #555;
      display:flex; justify-content:space-between; gap:10px;
    }
    .process-tools { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

    .sub-task {
      background: #f9f9f9;
      border-left: 3px solid #ccc;
      padding: 5px 10px;
      margin-top: 5px;
      font-size: 0.8em;
      color: #666;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      position: relative;
      padding-right: 118px; /* espacio bander√≠n + botones */
    }

    /* ====== ESTADOS DE PROCESO ====== */
    .process-box.status-ok{ border-left-color:#16a34a; }
    .process-box.status-progress{ border-left-color:#f59e0b; }
    .process-box.status-late{ border-left-color:#dc2626; }

    .status-select{
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.78em;
      background: #fff;
      cursor: pointer;
    }

    /* ====== BANDER√çN EN TAREAS ====== */
    .task-flag{
      position:absolute;
      right: 92px;
      top: 50%;
      transform: translateY(-50%);
      width: 0; height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid #dc2626;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.08));
      pointer-events: none;
    }
    .task-flag::after{
      content:"";
      position:absolute;
      left: -12px;
      top: -8px;
      width: 3px;
      height: 16px;
      background: #dc2626;
      border-radius: 2px;
    }
    .task-flag.hide-flag{ display:none; }
    .flag-btn{ padding: 6px 8px; font-size: 0.78em; }

    /* ===== Colores ===== */
    .b1, .nomina, .gd, .b2, .b3, .b4, .b5 {
      background-color: #e3f2fd;
      border-top: 5px solid #1976d2;
    }
    .b1 .macro-title, .nomina .macro-title, .gd .macro-title, .b5 .macro-title { background-color: #1976d2; }
    .b2 .subblock-title, .b3 .subblock-title, .b4 .subblock-title, .b5 .subblock-title { background-color: #1976d2; }

    .connector { display: flex; align-items: center; justify-content: center; min-width: 30px; font-size: 24px; color: #ccc; }

    [contenteditable="true"]{
      outline:none;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }

    /* ====== EDICI√ìN LEGIBLE ====== */
    [contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(25,118,210,0.25);
      background: #ffffff !important;
      color: #111 !important;
      caret-color: #111 !important;
      text-shadow: none !important;
    }

    .macro-title[contenteditable="true"]:focus,
    .subblock-title[contenteditable="true"]:focus{
      display: inline-block;
      max-width: 100%;
    }

    .hide { display:none !important; }

    /* =================== EXPORT =================== */
    body.exporting .no-export { display:none !important; }

    body.exporting [contenteditable="true"]{
      box-shadow: none !important;
      outline: none !important;
      background: initial !important;
      color: initial !important;
      caret-color: initial !important;
    }

    body.exporting .flow-container,
    body.exporting .subflow{
      overflow: visible !important;
    }

    body.exporting #captureArea{
      width: max-content !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
  </style>
</head>

<body>
  <div class="no-export">
    <h1 contenteditable="true" data-path="page.title">Ciclo de Gesti√≥n de Personas y N√≥mina</h1>
    
    <div class="toolbar">
      <input id="q" type="search" placeholder="Buscar en todo el flujo...">
      <button class="btn primary" id="addMacro">+ Bloque</button>
      <button class="btn danger" id="deleteMacro">Eliminar bloque</button>

      <button class="btn" id="exportJson">Exportar JSON</button>
      <button class="btn" id="importJsonBtn">Importar JSON</button>
      <input class="hide" id="importJsonFile" type="file" accept="application/json">

      <button class="btn" id="exportHtml">Exportar HTML</button>
      <button class="btn" id="exportPng">Exportar PNG (HD)</button>
      <button class="btn" id="exportPdf">Exportar PDF (HD)</button>
      <button class="btn danger" id="resetAll">Restaurar original</button>
    </div>
  </div>

  <div id="captureArea">
    <h1 id="exportTitle" style="text-align:center;color:#333;margin:0 0 12px 0;">Ciclo de Gesti√≥n de Personas y N√≥mina</h1>
    <div class="flow-container" id="flow"></div>
  </div>

  <script id="INITIAL_MODEL" type="application/json">
{
  "page": { "title": "Ciclo de Gesti√≥n de Personas y N√≥mina" },
  "macros": []
}
  </script>

  <script>
    const STORAGE_KEY = "flujo_rrhh_nomina_macro_v8";
    const flow = document.getElementById("flow");
    const q = document.getElementById("q");
    const exportTitle = document.getElementById("exportTitle");
    const captureArea = document.getElementById("captureArea");
    const uid = () => (Math.random().toString(16).slice(2) + Date.now().toString(16));

    // ===== Polyfills =====
    if(!String.prototype.replaceAll){
      // eslint-disable-next-line no-extend-native
      String.prototype.replaceAll = function(search, replacement){
        return this.split(search).join(replacement);
      };
    }
    if(!window.CSS) window.CSS = {};
    if(!window.CSS.escape){
      window.CSS.escape = function(value){
        return String(value).replace(/[^a-zA-Z0-9_\-]/g, function(ch){
          const hex = ch.charCodeAt(0).toString(16).toUpperCase();
          return "\\ " + hex + " ";
        });
      };
    }

    function loadDefault(){ return JSON.parse(document.getElementById("INITIAL_MODEL").textContent); }
    function loadModel(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return loadDefault();
        const parsed = JSON.parse(raw);
        if(!parsed || !parsed.macros) return loadDefault();
        return parsed;
      }catch(e){ return loadDefault(); }
    }
    function saveModel(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(model)); }
    let model = loadModel();

    const MACRO_PALETTE = ["b1", "nomina", "gd", "b5"];
    const SUBPROC_PALETTE = ["b2", "b3", "b4", "b5"];

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function ensureSubprocesses(m){
      if(!Array.isArray(m.subprocesses)) m.subprocesses = [];
      m.subprocesses.forEach(sb => {
        if(!Array.isArray(sb.sections)) sb.sections = [];
        sb.sections.forEach(sec => { if(!Array.isArray(sec.tasks)) sec.tasks = []; });
      });
    }

    // ===== Normalizaci√≥n =====
    function normalizeModel(input){
      const mm = input || model;
      if(!mm.page) mm.page = { title: "Ciclo de Gesti√≥n de Personas y N√≥mina" };
      if(!Array.isArray(mm.macros)) mm.macros = [];

      mm.macros.forEach(m=>{
        if(!m.id) m.id = "m_" + uid();
        if(!m.className) m.className = "b1";
        if(!Array.isArray(m.subprocesses)) m.subprocesses = [];
        m.subprocesses.forEach(sb=>{
          if(!sb.id) sb.id = "sb_" + uid();
          if(!sb.className) sb.className = "b2";
          if(!Array.isArray(sb.sections)) sb.sections = [];
          sb.sections.forEach(sec=>{
            if(!sec.id) sec.id = "s_" + uid();
            if(!sec.status) sec.status = "progress";
            if(!Array.isArray(sec.tasks)) sec.tasks = [];
            sec.tasks = sec.tasks.map(t => {
              if(t && typeof t === "object") return { text: (t.text ?? ""), flag: !!t.flag };
              return { text: (t ?? "").toString(), flag: false };
            });
          });
        });
      });

      return mm;
    }

    model = normalizeModel(model);
    saveModel();

    function pickClass(palette, usedSet){
      for(const c of palette){
        if(!usedSet.has(c)) return c;
      }
      return palette[usedSet.size % palette.length] || palette[0];
    }

    function getUsedMacroClasses(){
      const used = new Set();
      (model.macros || []).forEach(m => used.add(m.className || ""));
      return used;
    }

    function getUsedSubprocClasses(macroId){
      const used = new Set();
      const m = (model.macros || []).find(x => x.id === macroId);
      if(!m) return used;
      (m.subprocesses || []).forEach(sb => used.add(sb.className || ""));
      return used;
    }

    function render(){
      try{
        const title = model.page?.title || "Ciclo";
        const titleEl = document.querySelector('[data-path="page.title"]');
        if(titleEl && titleEl !== document.activeElement) titleEl.textContent = title;
        exportTitle.textContent = title;

        const frag = document.createDocumentFragment();

        const macros = model.macros || [];
        macros.forEach(ensureSubprocesses);

        macros.forEach((m, i) => {
          const macro = document.createElement("div");
          macro.className = `macro ${m.className || ""}`;
          macro.setAttribute("data-macro", m.id);
          macro.setAttribute("draggable","true");

          macro.innerHTML = `
            <div class="macro-topbar no-export">
              <span class="drag-handle macro-drag" title="Arrastra para reordenar bloques" aria-label="Arrastrar bloque">‚†ø</span>
            </div>

            <div class="macro-title" contenteditable="true" data-path="macros.${m.id}.title">${esc(m.title || "")}</div>
            <div class="macro-desc" contenteditable="true" data-path="macros.${m.id}.desc">${esc(m.desc || "")}</div>

            <div class="macro-actions no-export">
              <button class="btn" data-action="addSubprocess" data-macro="${esc(m.id)}">+ Subproceso</button>
              <button class="btn danger" data-action="deleteMacroInline" data-macro="${esc(m.id)}">Eliminar bloque</button>
            </div>

            <div class="subflow" data-subflow="${esc(m.id)}">
              ${(m.subprocesses || []).map((sb) => `
                <div class="subblock ${esc(sb.className || "b5")}" data-sub="${esc(sb.id)}" draggable="true">
                  <div class="subblock-topbar no-export">
                    <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">‚†ø</span>
                    <button class="btn" data-action="addSection" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}">+ Caja proceso</button>
                    <button class="btn danger" data-action="deleteSubprocess" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}">Eliminar subproceso</button>
                  </div>

                  <div class="subblock-title" contenteditable="true"
                    data-path="macros.${m.id}.subprocesses.${sb.id}.title">${esc(sb.title || "")}</div>

                  ${(sb.sections || []).map(sec => {
                    const st = (sec.status || "progress");
                    const statusClass = st === "ok" ? "status-ok" : (st === "late" ? "status-late" : "status-progress");
                    return `
                      <div class="process-box ${statusClass}" data-section="${esc(sec.id)}">
                        <div class="process-title">
                          <span contenteditable="true"
                            data-path="macros.${m.id}.subprocesses.${sb.id}.sections.${sec.id}.title">${esc(sec.title || "")}</span>
                          <span class="process-tools no-export">
                            <select class="status-select" data-action="setStatus"
                              data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}" aria-label="Estado">
                              <option value="ok" ${st==="ok"?"selected":""}>OK</option>
                              <option value="progress" ${(st==="progress"||!st)?"selected":""}>En proceso</option>
                              <option value="late" ${st==="late"?"selected":""}>Atrasado</option>
                            </select>
                            <button class="btn" data-action="addTask" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}">+ Tarea</button>
                            <button class="btn danger" data-action="deleteSection" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}">Eliminar</button>
                          </span>
                        </div>

                        ${(sec.tasks || []).map((t, ti) => {
                          const text = (t && typeof t === "object") ? (t.text ?? "") : (t ?? "");
                          const flagged = (t && typeof t === "object") ? !!t.flag : false;
                          return `
                            <div class="sub-task">
                              <span contenteditable="true"
                                data-path="macros.${m.id}.subprocesses.${sb.id}.sections.${sec.id}.tasks.${ti}">${esc(text)}</span>
                              <i class="task-flag ${flagged ? "" : "hide-flag"}" aria-hidden="true"></i>
                              <span class="no-export" style="display:flex;gap:6px;align-items:center;">
                                <button class="btn danger flag-btn" data-action="toggleFlag"
                                  data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}" data-task="${ti}"
                                  title="Marcar/desmarcar bander√≠n">üö©</button>
                                <button class="btn danger" data-action="deleteTask"
                                  data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}" data-task="${ti}">Eliminar</button>
                              </span>
                            </div>
                          `;
                        }).join("")}
                      </div>
                    `;
                  }).join("")}
                </div>
              `).join("")}
            </div>
          `;

          frag.appendChild(macro);

          if(i < macros.length - 1){
            const conn = document.createElement("div");
            conn.className = "connector";
            conn.textContent = "‚ûî";
            frag.appendChild(conn);
          }
        });

        flow.replaceChildren(frag);

        wireDnDMacros();
        wireDnDAllMacros();
        applyFilter();
      }catch(err){
        console.error('Render error', err);
        alert('Ocurri√≥ un error al cargar el diagrama. Revisa la consola (F12) para ver el detalle.');
      }
    }

    function setByPath(path, value){
      if(!path) return;
      const p = path.split(".");

      if(p[0] === "page" && p[1] === "title"){
        model.page.title = value;
        saveModel();
        exportTitle.textContent = value || "";
        return;
      }

      if(p[0] !== "macros") return;
      const macroId = p[1];
      const m = (model.macros || []).find(x => x.id === macroId);
      if(!m) return;

      if(p[2] === "title"){ m.title = value; saveModel(); return; }
      if(p[2] === "desc"){ m.desc = value; saveModel(); return; }

      if(p[2] === "subprocesses"){
        const subId = p[3];
        const sb = (m.subprocesses || []).find(x => x.id === subId);
        if(!sb) return;

        if(p[4] === "title"){ sb.title = value; saveModel(); return; }

        if(p[4] === "sections"){
          const secId = p[5];
          const sec = (sb.sections || []).find(x => x.id === secId);
          if(!sec) return;

          if(p[6] === "title"){ sec.title = value; saveModel(); return; }
          if(p[6] === "tasks"){
            const idx = Number(p[7]);
            if(!Array.isArray(sec.tasks)) sec.tasks = [];
            if(sec.tasks[idx] && typeof sec.tasks[idx] === 'object'){
              sec.tasks[idx].text = value;
            }else{
              sec.tasks[idx] = { text: value, flag: false };
            }
            saveModel(); return;
          }
        }
      }
    }

    document.addEventListener("input", (ev) => {
      const el = ev.target;
      const path = el?.getAttribute?.("data-path");
      if(!path) return;
      setByPath(path, el.textContent);
    });

    // ===== CRUD =====
    function addSubprocess(macroId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      ensureSubprocesses(m);

      const used = getUsedSubprocClasses(macroId);
      const cls = pickClass(SUBPROC_PALETTE, used);

      const newId = "sb_" + uid();
      m.subprocesses.push({
        id: newId,
        className: cls,
        title: "Nuevo subproceso",
        sections: [{ id: "p_" + uid(), title: "Nuevo proceso", status: "progress", tasks: [{text:"Nueva tarea", flag:false}] }]
      });
      saveModel(); render();
    }

    function deleteSubprocess(macroId, subId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m || !Array.isArray(m.subprocesses)) return;
      m.subprocesses = m.subprocesses.filter(x => x.id !== subId);
      saveModel(); render();
    }

    function addSection(macroId, subId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      if(!sb) return;
      if(!Array.isArray(sb.sections)) sb.sections = [];
      sb.sections.push({ id: "s_" + uid(), title: "Nuevo proceso", status: "progress", tasks: [{text:"Nueva tarea", flag:false}] });
      saveModel(); render();
    }

    function deleteSection(macroId, subId, sectionId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      if(!sb) return;
      sb.sections = (sb.sections || []).filter(x => x.id !== sectionId);
      saveModel(); render();
    }

    function addTask(macroId, subId, sectionId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec) return;
      if(!Array.isArray(sec.tasks)) sec.tasks = [];
      sec.tasks.push({ text: "Nueva tarea", flag: false });
      saveModel(); render();
    }

    function deleteTask(macroId, subId, sectionId, idx){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec || !Array.isArray(sec.tasks)) return;
      sec.tasks.splice(idx, 1);
      saveModel(); render();
    }

    function setStatus(macroId, subId, sectionId, status){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec) return;
      sec.status = (status === "ok" || status === "late" || status === "progress") ? status : "progress";
      saveModel(); render();
    }

    function toggleFlag(macroId, subId, sectionId, idx){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec || !Array.isArray(sec.tasks)) return;

      const t = sec.tasks[idx];
      if(t && typeof t === "object"){
        t.flag = !t.flag;
      }else{
        sec.tasks[idx] = { text: (t ?? "").toString(), flag: true };
      }
      saveModel(); render();
    }

    // ===== Agregar / Eliminar BLOQUE (macro) =====
    function addMacro(){
      const used = getUsedMacroClasses();
      const cls = pickClass(MACRO_PALETTE, used);

      const newId = "m_" + uid();
      const spCls = pickClass(SUBPROC_PALETTE, new Set());

      model.macros.push({
        id: newId,
        className: cls,
        title: "Nuevo Bloque",
        desc: "Descripci√≥n del bloque",
        subprocesses: [
          {
            id: "sb_" + uid(),
            className: spCls,
            title: "Subproceso",
            sections: [{ id: "s_" + uid(), title: "Proceso", status: "progress", tasks: [{text:"Tarea", flag:false}] }]
          }
        ]
      });

      saveModel(); render();
    }

    function deleteMacroById(macroId){
      if(!macroId) return;
      if(model.macros.length <= 1){
        alert("No puedes eliminar el √∫ltimo bloque.");
        return;
      }
      model.macros = model.macros.filter(m => m.id !== macroId);
      saveModel(); render();
    }

    document.getElementById("addMacro").addEventListener("click", addMacro);
    document.getElementById("deleteMacro").addEventListener("click", () => {
      const last = model.macros[model.macros.length - 1];
      deleteMacroById(last?.id);
    });

    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest?.("button[data-action]");
      if(!btn) return;

      const a = btn.getAttribute("data-action");
      const macroId = btn.getAttribute("data-macro");
      const subId = btn.getAttribute("data-sub");
      const sectionId = btn.getAttribute("data-section");
      const taskIdx = btn.getAttribute("data-task");

      if(a === "addSubprocess") addSubprocess(macroId);
      if(a === "deleteSubprocess") deleteSubprocess(macroId, subId);
      if(a === "addSection") addSection(macroId, subId);
      if(a === "deleteSection") deleteSection(macroId, subId, sectionId);
      if(a === "addTask") addTask(macroId, subId, sectionId);
      if(a === "deleteTask") deleteTask(macroId, subId, sectionId, Number(taskIdx));
      if(a === "toggleFlag") toggleFlag(macroId, subId, sectionId, Number(taskIdx));
      if(a === "deleteMacroInline") deleteMacroById(macroId);
    });

    // ===== Cambio de estado =====
    document.addEventListener("change", (ev) => {
      const sel = ev.target.closest?.('select[data-action="setStatus"]');
      if(!sel) return;
      const macroId = sel.getAttribute("data-macro");
      const subId = sel.getAttribute("data-sub");
      const sectionId = sel.getAttribute("data-section");
      setStatus(macroId, subId, sectionId, sel.value);
    });

    // ===== Drag & Drop: reordenar BLOQUES (macros) =====
    function wireDnDMacros(){
      const container = document.getElementById("flow");
      if(!container) return;

      let draggedId = null;

      const items = Array.from(container.querySelectorAll('.macro[draggable="true"]'));
      items.forEach(el => {
        const handle = el.querySelector('.macro-drag');
        if(handle){
          handle.addEventListener('mousedown', () => el.dataset.dragAllowed = "1");
          handle.addEventListener('mouseup',   () => el.dataset.dragAllowed = "0");
          handle.addEventListener('mouseleave',() => el.dataset.dragAllowed = "0");
        }

        el.addEventListener('dragstart', (e) => {
          if(el.dataset.dragAllowed !== "1"){ e.preventDefault(); return; }
          draggedId = el.getAttribute('data-macro');
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try{ e.dataTransfer.setData('text/plain', draggedId); }catch(_){}
        });

        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          el.dataset.dragAllowed = "0";
        });
      });

      container.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        const target = e.target.closest('.macro');
        if(!target) return;

        const toId = target.getAttribute('data-macro');
        const fromId = draggedId || (()=>{
          try{ return e.dataTransfer.getData('text/plain'); }catch(_){ return null; }
        })();

        if(!fromId || !toId || fromId === toId) return;

        const fromIndex = (model.macros || []).findIndex(x => x.id === fromId);
        const toIndex   = (model.macros || []).findIndex(x => x.id === toId);
        if(fromIndex < 0 || toIndex < 0) return;

        const [moved] = model.macros.splice(fromIndex, 1);
        model.macros.splice(toIndex, 0, moved);

        saveModel(); render();
      });
    }

    // ===== Drag & Drop: reordenar SUBPROCESOS =====
    function wireDnDAllMacros(){
      (model.macros || []).forEach(m => {
        const container = document.querySelector(`.subflow[data-subflow="${CSS.escape(m.id)}"]`);
        if(!container) return;

        let draggedId = null;

        const items = Array.from(container.querySelectorAll('.subblock[draggable="true"]'));
        items.forEach(el => {
          const handle = el.querySelector('.drag-handle:not(.macro-drag)');
          if(handle){
            handle.addEventListener('mousedown', () => el.dataset.dragAllowed = "1");
            handle.addEventListener('mouseup',   () => el.dataset.dragAllowed = "0");
            handle.addEventListener('mouseleave',() => el.dataset.dragAllowed = "0");
          }

          el.addEventListener('dragstart', (e) => {
            if(el.dataset.dragAllowed !== "1"){ e.preventDefault(); return; }
            draggedId = el.getAttribute('data-sub');
            el.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            try{ e.dataTransfer.setData('text/plain', draggedId); }catch(_){}
          });

          el.addEventListener('dragend', () => {
            el.classList.remove('dragging');
            el.dataset.dragAllowed = "0";
          });
        });

        container.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });

        container.addEventListener('drop', (e) => {
          e.preventDefault();
          const target = e.target.closest('.subblock');
          if(!target) return;

          const toId = target.getAttribute('data-sub');
          const fromId = draggedId || (()=>{
            try{ return e.dataTransfer.getData('text/plain'); }catch(_){ return null; }
          })();

          if(!fromId || !toId || fromId === toId) return;

          const mm = model.macros.find(x => x.id === m.id);
          if(!mm || !Array.isArray(mm.subprocesses)) return;

          const fromIndex = mm.subprocesses.findIndex(x => x.id === fromId);
          const toIndex   = mm.subprocesses.findIndex(x => x.id === toId);
          if(fromIndex < 0 || toIndex < 0) return;

          const [moved] = mm.subprocesses.splice(fromIndex, 1);
          mm.subprocesses.splice(toIndex, 0, moved);

          saveModel(); render();
        });
      });
    }

    // ===== Export / Import JSON =====
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("exportJson").addEventListener("click", () => {
      const clean = normalizeModel(JSON.parse(JSON.stringify(model)));
      const json = JSON.stringify(clean, null, 2);
      downloadBlob(new Blob([json], {type:"application/json;charset=utf-8"}), "flujo_modelo.json");
    });

    const importFile = document.getElementById("importJsonFile");
    document.getElementById("importJsonBtn").addEventListener("click", () => importFile.click());

    importFile.addEventListener("change", async () => {
      const file = importFile.files?.[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const parsed = JSON.parse(txt);
        const incoming = normalizeModel(parsed);

        // validaci√≥n m√≠nima estructural
        if(!incoming || !Array.isArray(incoming.macros)){
          alert("JSON inv√°lido: falta 'macros'.");
          importFile.value = "";
          return;
        }

        model = incoming;
        saveModel();
        render();
        alert("JSON importado OK.");
      }catch(e){
        console.error(e);
        alert("No se pudo importar: archivo no es JSON v√°lido o estructura incompatible.");
      }finally{
        importFile.value = "";
      }
    });

    // ===== Filtro =====
    function applyFilter(){
      const term = (q.value || "").trim().toLowerCase();
      const macrosEls = Array.from(document.querySelectorAll(".macro"));
      const connectors = Array.from(document.querySelectorAll(".connector"));

      if(!term){
        macrosEls.forEach(m => m.classList.remove("hide"));
        connectors.forEach(c => c.classList.remove("hide"));
        return;
      }

      macrosEls.forEach(m => {
        const hit = (m.innerText || m.textContent || "").toLowerCase().includes(term);
        m.classList.toggle("hide", !hit);
      });

      connectors.forEach((c, idx) => {
        const left = macrosEls[idx];
        const right = macrosEls[idx+1];
        const hide = (!left || left.classList.contains("hide")) || (!right || right.classList.contains("hide"));
        c.classList.toggle("hide", hide);
      });
    }
    q.addEventListener("input", applyFilter);

    // ===== Export PNG/PDF/HTML =====
    function setExporting(on){ document.body.classList.toggle("exporting", !!on); }
    function getDeviceScale(){
      const dpr = window.devicePixelRatio || 1;
      return Math.min(4, Math.max(2, dpr * 2));
    }

    async function captureFullCanvas(){
      if(typeof html2canvas !== "function"){
        alert("No se carg√≥ html2canvas (revisa conexi√≥n a internet o pol√≠ticas del navegador).");
        return null;
      }

      setExporting(true);
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      const el = captureArea;
      const width = el.scrollWidth;
      const height = el.scrollHeight;
      const scale = getDeviceScale();

      const canvas = await html2canvas(el, {
        scale,
        backgroundColor: "#f4f7f6",
        useCORS: true,
        width,
        height,
        windowWidth: width,
        windowHeight: height,
        scrollX: 0,
        scrollY: 0,
        logging: false
      });

      setExporting(false);
      return canvas;
    }

    document.getElementById("exportHtml").addEventListener("click", () => {
      const clone = document.documentElement.cloneNode(true);
      const script = clone.querySelector("#INITIAL_MODEL");
      script.textContent = "\n" + JSON.stringify(model, null, 2) + "\n";
      const html = "<!doctype html>\n" + clone.outerHTML;
      downloadBlob(new Blob([html], {type:"text/html;charset=utf-8"}), "flujo_macro_editable.html");
    });

    document.getElementById("exportPng").addEventListener("click", async () => {
      const canvas = await captureFullCanvas();
      if(!canvas) return;
      canvas.toBlob((blob) => {
        if(!blob) return;
        downloadBlob(blob, "flujo_hd.png");
      }, "image/png");
    });

    document.getElementById("exportPdf").addEventListener("click", async () => {
      const canvas = await captureFullCanvas();
      if(!canvas) return;

      if(!window.jspdf?.jsPDF){
        alert("No se carg√≥ jsPDF (revisa conexi√≥n a internet o pol√≠ticas del navegador).");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation: "landscape", unit: "pt", format: "a4", compress: true});

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const scale = pageW / canvas.width;
      const pageCanvasHeight = Math.floor(pageH / scale);

      const tmp = document.createElement("canvas");
      const tctx = tmp.getContext("2d", {alpha: false});

      let y = 0;
      let page = 0;

      while(y < canvas.height){
        const sliceH = Math.min(pageCanvasHeight, canvas.height - y);
        tmp.width = canvas.width;
        tmp.height = sliceH;

        tctx.clearRect(0, 0, tmp.width, tmp.height);
        tctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

        const sliceData = tmp.toDataURL("image/png");
        if(page > 0) pdf.addPage();
        const drawH = sliceH * scale;

        pdf.addImage(sliceData, "PNG", 0, 0, pageW, drawH, undefined, "FAST");
        y += sliceH;
        page++;
      }

      pdf.save("flujo_hd.pdf");
    });

    // ===== Restaurar =====
    document.getElementById("resetAll").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      model = normalizeModel(loadDefault());
      saveModel();
      render();
    });

    // ===== Si est√° vac√≠o, arma un ejemplo m√≠nimo =====
    if(!model.macros || model.macros.length === 0){
      model.macros = [
        {
          id: "m1",
          className: "b1",
          title: "1. Ingreso a EESS",
          desc: "Ingreso del trabajador y datos base (sistema fuente).",
          subprocesses: [
            {
              id: "sb_1",
              className: "b2",
              title: "Subproceso",
              sections: [
                { id:"s_1", title:"Proceso", status:"progress", tasks:[{text:"Tarea", flag:false}] }
              ]
            }
          ]
        }
      ];
      saveModel();
    }

    // boot
    render();
  </script>
</body>
</html>
