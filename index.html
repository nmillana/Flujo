<!doctype html>
<html lang="es"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagrama de Flujo - RRHH y Nómina (Editable)</title>

  <!-- Export PNG/PDF -->
  <script defer="" src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer="" src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 20px; }
    h1 { text-align: center; color: #333; margin-bottom: 10px; }
    .hint { text-align:center; color:#666; font-size: 0.9em; margin: 0 0 20px; }

    #captureArea{ width:max-content; }
    .flow-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }

    .macro {
      width: max-content;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      flex: 0 0 auto;
    }

    .macro-title {
      font-weight: bold; text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 12px;
      color: white; text-transform: uppercase; font-size: 0.9em;
    }
    .macro-desc{ text-align:center; color:#555; font-size: 0.85em; margin: 0 0 12px; max-width: 1300px; }

    .macro-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin: 8px 0 15px; }
    .btn {
      border: 1px solid rgba(0,0,0,0.15);
      background: #fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 0.82em;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      white-space: nowrap;
    }
    .btn:hover { background:#f9f9f9; }
    .danger { border-color: rgba(220,38,38,0.25); color:#b91c1c; }
    .primary { border-color: rgba(37,99,235,0.3); color:#1d4ed8; }

    .toolbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin: 0 0 18px; }
    .toolbar input{
      width: min(520px, 92vw);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      outline: none;
      background: #fff;
    }

    .subflow { display:flex; gap: 14px; overflow-x:auto; padding-bottom: 10px; align-items:flex-start; width: max-content; }
    .subflow::-webkit-scrollbar{height:10px}
    .subflow::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:999px}
    .subflow::-webkit-scrollbar-track{background:rgba(0,0,0,.06);border-radius:999px}

    .subblock { width: max-content; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); flex: 0 0 auto; }
    .subblock-title { font-weight: bold; text-align: center; padding: 9px; border-radius: 5px; margin-bottom: 10px; color: white; text-transform: uppercase; font-size: 0.82em; }

    .subblock[draggable="true"]{ cursor: grab; }
    .subblock.dragging{ opacity: 0.6; transform: scale(0.995); }
    .drag-handle{
      display:inline-flex; align-items:center; justify-content:center;
      width: 28px; height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.75);
      cursor: grab;
      user-select:none;
      font-size: 14px;
    }
    .subblock-topbar{
      display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;
      margin: -2px 0 10px;
    }

    .process-box { background: white; border: 1px solid #ddd; border-radius: 5px; padding: 12px; margin-bottom: 12px; min-width: 260px; }
    .process-title {
      font-weight: bold; font-size: 0.85em; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; color: #555;
      display:flex; justify-content:space-between; gap:10px;
    }
    .process-tools { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }

    .sub-task {
      background: #f9f9f9; border-left: 3px solid #ccc; padding: 5px 10px; margin-top: 5px;
      font-size: 0.8em; color: #666; display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }

    /* ===== Colores ===== */
    .b1 { background-color: #e3f2fd; border-top: 5px solid #1976d2; }
    .b1 .macro-title { background-color: #1976d2; }

    .nomina { background-color: #fafafa; border-top: 5px solid #455a64; }
    .nomina .macro-title { background-color: #455a64; }

    .gd { background-color: #eef2ff; border-top: 5px solid #4f46e5; }
    .gd .macro-title { background-color: #4f46e5; }

    .b2 { background-color: #fff3e0; border-top: 5px solid #fb8c00; }
    .b2 .subblock-title { background-color: #fb8c00; }

    .b3 { background-color: #f3e5f5; border-top: 5px solid #8e24aa; }
    .b3 .subblock-title { background-color: #8e24aa; }

    .b4 { background-color: #e8f5e9; border-top: 5px solid #43a047; }
    .b4 .subblock-title { background-color: #43a047; }

    .b5 { background-color: #eceff1; border-top: 5px solid #607d8b; }
    .b5 .subblock-title { background-color: #607d8b; }
    /* FIX: macro-title para b5 (si un macro usa b5) */
    .b5 .macro-title { background-color: #607d8b; }

    .connector { display: flex; align-items: center; justify-content: center; min-width: 30px; font-size: 24px; color: #ccc; }

    [contenteditable="true"]{
      outline:none;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }

    /* ====== EDICIÓN LEGIBLE: SIEMPRE NEGRO AL EDITAR ====== */
    [contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(25,118,210,0.25);
      background: #ffffff !important;
      color: #111 !important;
      caret-color: #111 !important;
      text-shadow: none !important;
    }

    .macro-title[contenteditable="true"]:focus,
    .subblock-title[contenteditable="true"]:focus{
      display: inline-block;
      max-width: 100%;
    }

    .hide { display:none !important; }

    /* =================== EXPORT =================== */
    body.exporting .no-export { display:none !important; }

    body.exporting [contenteditable="true"]{
      box-shadow: none !important;
      outline: none !important;
      background: initial !important;
      color: initial !important;
      caret-color: initial !important;
    }

    body.exporting .flow-container,
    body.exporting .subflow{
      overflow: visible !important;
    }

    body.exporting #captureArea{
      width: max-content !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
  </style>
</head>

<body>
  <div class="no-export">
    <h1 contenteditable="true" data-path="page.title">Ciclo de Gestión de Personas y Nómina</h1>
    <p class="hint">
      ✅ Al crear un <b>Bloque</b> o <b>Subproceso</b>, el sistema asigna un <b>color distinto</b> (primero usa los no ocupados, luego rota).<br>
      ✅ Al editar, el texto pasa a <b>negro</b> para que se lea perfecto.
    </p>

    <div class="toolbar">
      <input id="q" type="search" placeholder="Buscar en todo el flujo...">
      <button class="btn primary" id="addMacro">+ Bloque</button>
      <button class="btn danger" id="deleteMacro">Eliminar bloque</button>
      <button class="btn" id="exportHtml">Exportar HTML</button>
      <button class="btn" id="exportPng">Exportar PNG (HD)</button>
      <button class="btn" id="exportPdf">Exportar PDF (HD)</button>
      <button class="btn danger" id="resetAll">Restaurar original</button>
    </div>
  </div>

  <div id="captureArea">
    <h1 id="exportTitle" style="text-align:center;color:#333;margin:0 0 12px 0;">Ciclo de Gestión de Personas y Nómina</h1>
    <div class="flow-container" id="flow"><div class="macro b1" data-macro="m1">
          <div class="macro-title" contenteditable="true" data-path="macros.m1.title">1. Ingreso a EESS</div>
          <div class="macro-desc" contenteditable="true" data-path="macros.m1.desc">Ingreso del trabajador y datos base (sistema fuente).</div>

          <div class="macro-actions no-export">
            <button class="btn" data-action="addSubprocess" data-macro="m1">+ Subproceso</button>
            <button class="btn danger" data-action="deleteMacroInline" data-macro="m1">Eliminar bloque</button>
          </div>

          <div class="subflow" data-subflow="m1">
            
              <div class="subblock b2" data-sub="sp_ing_1" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m1" data-sub="sp_ing_1">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m1" data-sub="sp_ing_1">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.title">Ingreso y Datos Base</div>

                
                  <div class="process-box" data-section="s1">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s1.title">Origen del trabajador (entradas al proceso</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m1" data-sub="sp_ing_1" data-section="s1">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m1" data-sub="sp_ing_1" data-section="s1">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s1.tasks.0">
 Selección
     + Onboarding (con Administración de la Compensación)
</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s1" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s1.tasks.1">
 Selección,
     Reclutamiento y Onboarding
</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s1" data-task="1">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s1.tasks.2">Selección, Reclutamiento y Onboarding Obra Directivo</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s1" data-task="2">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s1.tasks.3">Obra Operario</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s1" data-task="3">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="s2">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s2.title">Alta administrativa trabajador en EESS</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m1" data-sub="sp_ing_1" data-section="s2">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m1" data-sub="sp_ing_1" data-section="s2">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s2.tasks.0">Ingreso datos personales</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s2" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s2.tasks.1">Ingreso datos contractuales</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s2" data-task="1">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s2.tasks.2">Definición estructura organizacional</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s2" data-task="2">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m1.subprocesses.sp_ing_1.sections.s2.tasks.3">Asignación centro de costo</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m1" data-sub="sp_ing_1" data-section="s2" data-task="3">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
          </div>
        </div><div class="connector">➔</div><div class="macro nomina" data-macro="m2">
          <div class="macro-title" contenteditable="true" data-path="macros.m2.title">2. Nómina (Macroproceso)</div>
          <div class="macro-desc" contenteditable="true" data-path="macros.m2.desc">Subprocesos 2 → 5: Configuración y Asistencia → Cálculo y Finiquitos → Tesorería y Centralización → Reportes y Gestión.</div>

          <div class="macro-actions no-export">
            <button class="btn" data-action="addSubprocess" data-macro="m2">+ Subproceso</button>
            <button class="btn danger" data-action="deleteMacroInline" data-macro="m2">Eliminar bloque</button>
          </div>

          <div class="subflow" data-subflow="m2">
            
              <div class="subblock b2" data-sub="b2" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m2" data-sub="b2">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m2" data-sub="b2">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m2.subprocesses.b2.title">2. Configuración y Asistencia</div>

                
                  <div class="process-box" data-section="p1">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p1.title">Parámetros Nómina</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b2" data-section="p1">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b2" data-section="p1">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p1.tasks.0">Bancos / Gratificación / Impuestos</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b2" data-section="p1" data-task="0">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="p2">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p2.title">Recinto (Puesta en Vivo)</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b2" data-section="p2">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b2" data-section="p2">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p2.tasks.0">Habilitar Reloj-App / Sincro Subcontratos</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b2" data-section="p2" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p2.tasks.1">Fiscalización DT / Portal Asistencia</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b2" data-section="p2" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="p3">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p3.title">Mantención Mensual</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b2" data-section="p3">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b2" data-section="p3">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p3.tasks.0">Nómina: Vacaciones y Licencias</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b2" data-section="p3" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b2.sections.p3.tasks.1">Recinto: Horas Extras y Faltas</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b2" data-section="p3" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
              <div class="subblock b3" data-sub="b3" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m2" data-sub="b3">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m2" data-sub="b3">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m2.subprocesses.b3.title">3. Cálculo y Finiquitos</div>

                
                  <div class="process-box" data-section="p4">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p4.title">Proceso Sueldos</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b3" data-section="p4">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b3" data-section="p4">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p4.tasks.0">Actualizar Haberes Movilización</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b3" data-section="p4" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p4.tasks.1">Anticipo → Sueldo → Ajustes</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b3" data-section="p4" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="p5">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p5.title">Proceso Finiquitos</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b3" data-section="p5">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b3" data-section="p5">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p5.tasks.0">Simular Baja / Grabar / Imprimir</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b3" data-section="p5" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b3.sections.p5.tasks.1">Anticipado o Fin de Mes</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b3" data-section="p5" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
              <div class="subblock b4" data-sub="b4" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m2" data-sub="b4">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m2" data-sub="b4">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m2.subprocesses.b4.title">4. Tesorería y Centralización</div>

                
                  <div class="process-box" data-section="p6">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p6.title">Medios de Pago</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b4" data-section="p6">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b4" data-section="p6">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p6.tasks.0">Cta. Cte. / Efectivo / Vale Vista</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b4" data-section="p6" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p6.tasks.1">Prueba Ingreso Ficha</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b4" data-section="p6" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="p7">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p7.title">Centralización</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b4" data-section="p7">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b4" data-section="p7">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p7.tasks.0">Sueldos y Ajustes</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b4" data-section="p7" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b4.sections.p7.tasks.1">(Elimina Cent. Finiquitos)</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b4" data-section="p7" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
              <div class="subblock b5" data-sub="b5" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m2" data-sub="b5">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m2" data-sub="b5">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m2.subprocesses.b5.title">5. Reportes y Gestión</div>

                
                  <div class="process-box" data-section="p8">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p8.title">Cierres Legales</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b5" data-section="p8">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b5" data-section="p8">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p8.tasks.0">INE / LRE / Leyes Sociales</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b5" data-section="p8" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p8.tasks.1">CIERRE MENSUAL</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b5" data-section="p8" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="p9">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p9.title">Gestión de Nómina</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m2" data-sub="b5" data-section="p9">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m2" data-sub="b5" data-section="p9">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p9.tasks.0">Préstamos / Seguros / Vacaciones</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b5" data-section="p9" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m2.subprocesses.b5.sections.p9.tasks.1">Masa Constructora / Especialidades</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m2" data-sub="b5" data-section="p9" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
          </div>
        </div><div class="connector">➔</div><div class="macro gd" data-macro="m3">
          <div class="macro-title" contenteditable="true" data-path="macros.m3.title">3. Gestión Documental</div>
          <div class="macro-desc" contenteditable="true" data-path="macros.m3.desc">Contratos, anexos, respaldos y trazabilidad documental asociada al ciclo.</div>

          <div class="macro-actions no-export">
            <button class="btn" data-action="addSubprocess" data-macro="m3">+ Subproceso</button>
            <button class="btn danger" data-action="deleteMacroInline" data-macro="m3">Eliminar bloque</button>
          </div>

          <div class="subflow" data-subflow="m3">
            
              <div class="subblock b5" data-sub="sp_gd_1" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="m3" data-sub="sp_gd_1">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="m3" data-sub="sp_gd_1">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.title">Gestión y Respaldo</div>

                
                  <div class="process-box" data-section="g1">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g1.title">Documentación Laboral</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m3" data-sub="sp_gd_1" data-section="g1">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m3" data-sub="sp_gd_1" data-section="g1">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g1.tasks.0">Contratos / Anexos / Aviso DT</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m3" data-sub="sp_gd_1" data-section="g1" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g1.tasks.1">Firmas / Versionado / Vigencias</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m3" data-sub="sp_gd_1" data-section="g1" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
                  <div class="process-box" data-section="g2">
                    <div class="process-title">
                      <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g2.title">Respaldo del Ciclo</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="m3" data-sub="sp_gd_1" data-section="g2">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="m3" data-sub="sp_gd_1" data-section="g2">Eliminar</button>
                      </span>
                    </div>

                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g2.tasks.0">Centralizaciones / Reportes / Comprobantes</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m3" data-sub="sp_gd_1" data-section="g2" data-task="0">Eliminar</button>
                      </div>
                    
                      <div class="sub-task">
                        <span contenteditable="true" data-path="macros.m3.subprocesses.sp_gd_1.sections.g2.tasks.1">Auditoría y trazabilidad</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="m3" data-sub="sp_gd_1" data-section="g2" data-task="1">Eliminar</button>
                      </div>
                    
                  </div>
                
              </div>
            
          </div>
        </div></div>
  </div>

  <script id="INITIAL_MODEL" type="application/json">
{
  "page": {
    "title": "Ciclo de Gestión de Personas y Nómina"
  },
  "macros": [
    {
      "id": "m1",
      "className": "b1",
      "title": "1. Ingreso a EESS",
      "desc": "Ingreso del trabajador y datos base (sistema fuente).",
      "subprocesses": [
        {
          "id": "sp_ing_1",
          "className": "b2",
          "title": "Ingreso y Datos Base",
          "sections": [
            {
              "id": "s1",
              "title": "Origen del trabajador (entradas al proceso",
              "tasks": [
                "\n Selección\n     + Onboarding (con Administración de la Compensación)\n",
                "\n Selección,\n     Reclutamiento y Onboarding\n",
                "Selección, Reclutamiento y Onboarding Obra Directivo",
                "Obra Operario"
              ]
            },
            {
              "id": "s2",
              "title": "Alta administrativa trabajador en EESS",
              "tasks": [
                "Ingreso datos personales",
                "Ingreso datos contractuales",
                "Definición estructura organizacional",
                "Asignación centro de costo"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "m2",
      "className": "nomina",
      "title": "2. Nómina (Macroproceso)",
      "desc": "Subprocesos 2 → 5: Configuración y Asistencia → Cálculo y Finiquitos → Tesorería y Centralización → Reportes y Gestión.",
      "subprocesses": [
        {
          "id": "b2",
          "className": "b2",
          "title": "2. Configuración y Asistencia",
          "sections": [
            {
              "id": "p1",
              "title": "Parámetros Nómina",
              "tasks": [
                "Bancos / Gratificación / Impuestos"
              ]
            },
            {
              "id": "p2",
              "title": "Recinto (Puesta en Vivo)",
              "tasks": [
                "Habilitar Reloj-App / Sincro Subcontratos",
                "Fiscalización DT / Portal Asistencia"
              ]
            },
            {
              "id": "p3",
              "title": "Mantención Mensual",
              "tasks": [
                "Nómina: Vacaciones y Licencias",
                "Recinto: Horas Extras y Faltas"
              ]
            }
          ]
        },
        {
          "id": "b3",
          "className": "b3",
          "title": "3. Cálculo y Finiquitos",
          "sections": [
            {
              "id": "p4",
              "title": "Proceso Sueldos",
              "tasks": [
                "Actualizar Haberes Movilización",
                "Anticipo → Sueldo → Ajustes"
              ]
            },
            {
              "id": "p5",
              "title": "Proceso Finiquitos",
              "tasks": [
                "Simular Baja / Grabar / Imprimir",
                "Anticipado o Fin de Mes"
              ]
            }
          ]
        },
        {
          "id": "b4",
          "className": "b4",
          "title": "4. Tesorería y Centralización",
          "sections": [
            {
              "id": "p6",
              "title": "Medios de Pago",
              "tasks": [
                "Cta. Cte. / Efectivo / Vale Vista",
                "Prueba Ingreso Ficha"
              ]
            },
            {
              "id": "p7",
              "title": "Centralización",
              "tasks": [
                "Sueldos y Ajustes",
                "(Elimina Cent. Finiquitos)"
              ]
            }
          ]
        },
        {
          "id": "b5",
          "className": "b5",
          "title": "5. Reportes y Gestión",
          "sections": [
            {
              "id": "p8",
              "title": "Cierres Legales",
              "tasks": [
                "INE / LRE / Leyes Sociales",
                "CIERRE MENSUAL"
              ]
            },
            {
              "id": "p9",
              "title": "Gestión de Nómina",
              "tasks": [
                "Préstamos / Seguros / Vacaciones",
                "Masa Constructora / Especialidades"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "m3",
      "className": "gd",
      "title": "3. Gestión Documental",
      "desc": "Contratos, anexos, respaldos y trazabilidad documental asociada al ciclo.",
      "subprocesses": [
        {
          "id": "sp_gd_1",
          "className": "b5",
          "title": "Gestión y Respaldo",
          "sections": [
            {
              "id": "g1",
              "title": "Documentación Laboral",
              "tasks": [
                "Contratos / Anexos / Aviso DT",
                "Firmas / Versionado / Vigencias"
              ]
            },
            {
              "id": "g2",
              "title": "Respaldo del Ciclo",
              "tasks": [
                "Centralizaciones / Reportes / Comprobantes",
                "Auditoría y trazabilidad"
              ]
            }
          ]
        }
      ]
    }
  ]
}
</script>

  <script>
    const STORAGE_KEY = "flujo_rrhh_nomina_macro_v8";
    const flow = document.getElementById("flow");
    const q = document.getElementById("q");
    const exportTitle = document.getElementById("exportTitle");
    const captureArea = document.getElementById("captureArea");
    const uid = () => (Math.random().toString(16).slice(2) + Date.now().toString(16));

    function loadDefault(){ return JSON.parse(document.getElementById("INITIAL_MODEL").textContent); }
    function loadModel(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return loadDefault();
        const parsed = JSON.parse(raw);
        if(!parsed || !parsed.macros) return loadDefault();
        return parsed;
      }catch(e){ return loadDefault(); }
    }
    function saveModel(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(model)); }
    let model = loadModel();

    // Paletas separadas: macro vs subproceso
    const MACRO_PALETTE = ["b1", "nomina", "gd", "b5"];
    const SUBPROC_PALETTE = ["b2", "b3", "b4", "b5"];

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function ensureSubprocesses(m){
      if(!Array.isArray(m.subprocesses)) m.subprocesses = [];
      m.subprocesses.forEach(sb => {
        if(!Array.isArray(sb.sections)) sb.sections = [];
        sb.sections.forEach(sec => { if(!Array.isArray(sec.tasks)) sec.tasks = []; });
      });
    }

    // ===== Selección de color (primero el que NO está usado, si todos usados rota) =====
    function pickClass(palette, usedSet){
      for(const c of palette){
        if(!usedSet.has(c)) return c;
      }
      // si todos están usados: rota según cantidad existente para que vaya variando
      return palette[usedSet.size % palette.length] || palette[0];
    }

    function getUsedMacroClasses(){
      const used = new Set();
      (model.macros || []).forEach(m => used.add(m.className || ""));
      return used;
    }

    function getUsedSubprocClasses(macroId){
      const used = new Set();
      const m = (model.macros || []).find(x => x.id === macroId);
      if(!m) return used;
      (m.subprocesses || []).forEach(sb => used.add(sb.className || ""));
      return used;
    }

    function render(){
      const title = model.page?.title || "Ciclo";
      const titleEl = document.querySelector('[data-path="page.title"]');
      if(titleEl && titleEl !== document.activeElement) titleEl.textContent = title;
      exportTitle.textContent = title;

      flow.innerHTML = "";

      const macros = model.macros || [];
      macros.forEach(ensureSubprocesses);

      macros.forEach((m, i) => {
        const macro = document.createElement("div");
        macro.className = `macro ${m.className || ""}`;
        macro.setAttribute("data-macro", m.id);

        macro.innerHTML = `
          <div class="macro-title" contenteditable="true" data-path="macros.${m.id}.title">${esc(m.title || "")}</div>
          <div class="macro-desc" contenteditable="true" data-path="macros.${m.id}.desc">${esc(m.desc || "")}</div>

          <div class="macro-actions no-export">
            <button class="btn" data-action="addSubprocess" data-macro="${esc(m.id)}">+ Subproceso</button>
            <button class="btn danger" data-action="deleteMacroInline" data-macro="${esc(m.id)}">Eliminar bloque</button>
          </div>

          <div class="subflow" data-subflow="${esc(m.id)}">
            ${(m.subprocesses || []).map((sb) => `
              <div class="subblock ${esc(sb.className || "b5")}" data-sub="${esc(sb.id)}" draggable="true">
                <div class="subblock-topbar no-export">
                  <span class="drag-handle" title="Arrastra para reordenar" aria-label="Arrastrar">⠿</span>
                  <button class="btn" data-action="addSection" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}">+ Caja proceso</button>
                  <button class="btn danger" data-action="deleteSubprocess" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}">Eliminar subproceso</button>
                </div>

                <div class="subblock-title" contenteditable="true"
                  data-path="macros.${m.id}.subprocesses.${sb.id}.title">${esc(sb.title || "")}</div>

                ${(sb.sections || []).map(sec => `
                  <div class="process-box" data-section="${esc(sec.id)}">
                    <div class="process-title">
                      <span contenteditable="true"
                        data-path="macros.${m.id}.subprocesses.${sb.id}.sections.${sec.id}.title">${esc(sec.title || "")}</span>
                      <span class="process-tools no-export">
                        <button class="btn" data-action="addTask" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}">+ Tarea</button>
                        <button class="btn danger" data-action="deleteSection" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}">Eliminar</button>
                      </span>
                    </div>

                    ${(sec.tasks || []).map((t, ti) => `
                      <div class="sub-task">
                        <span contenteditable="true"
                          data-path="macros.${m.id}.subprocesses.${sb.id}.sections.${sec.id}.tasks.${ti}">${esc(t)}</span>
                        <button class="btn danger no-export" data-action="deleteTask" data-macro="${esc(m.id)}" data-sub="${esc(sb.id)}" data-section="${esc(sec.id)}" data-task="${ti}">Eliminar</button>
                      </div>
                    `).join("")}
                  </div>
                `).join("")}
              </div>
            `).join("")}
          </div>
        `;

        flow.appendChild(macro);

        if(i < macros.length - 1){
          const conn = document.createElement("div");
          conn.className = "connector";
          conn.textContent = "➔";
          flow.appendChild(conn);
        }
      });

      wireDnDAllMacros();
      applyFilter();
    }

    function setByPath(path, value){
      if(!path) return;
      const p = path.split(".");

      if(p[0] === "page" && p[1] === "title"){
        model.page.title = value;
        saveModel();
        exportTitle.textContent = value || "";
        return;
      }

      if(p[0] !== "macros") return;
      const macroId = p[1];
      const m = (model.macros || []).find(x => x.id === macroId);
      if(!m) return;

      if(p[2] === "title"){ m.title = value; saveModel(); return; }
      if(p[2] === "desc"){ m.desc = value; saveModel(); return; }

      if(p[2] === "subprocesses"){
        const subId = p[3];
        const sb = (m.subprocesses || []).find(x => x.id === subId);
        if(!sb) return;

        if(p[4] === "title"){ sb.title = value; saveModel(); return; }

        if(p[4] === "sections"){
          const secId = p[5];
          const sec = (sb.sections || []).find(x => x.id === secId);
          if(!sec) return;

          if(p[6] === "title"){ sec.title = value; saveModel(); return; }
          if(p[6] === "tasks"){
            const idx = Number(p[7]);
            if(!Array.isArray(sec.tasks)) sec.tasks = [];
            sec.tasks[idx] = value; saveModel(); return;
          }
        }
      }
    }

    document.addEventListener("input", (ev) => {
      const el = ev.target;
      const path = el?.getAttribute?.("data-path");
      if(!path) return;
      setByPath(path, el.textContent);
    });

    // ===== CRUD =====
    function addSubprocess(macroId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      ensureSubprocesses(m);

      // color distinto dentro del macro
      const used = getUsedSubprocClasses(macroId);
      const cls = pickClass(SUBPROC_PALETTE, used);

      const newId = "sb_" + uid();
      m.subprocesses.push({
        id: newId,
        className: cls,
        title: "Nuevo subproceso",
        sections: [{ id: "p_" + uid(), title: "Nuevo proceso", tasks: ["Nueva tarea"] }]
      });
      saveModel(); render();
    }

    function deleteSubprocess(macroId, subId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m || !Array.isArray(m.subprocesses)) return;
      m.subprocesses = m.subprocesses.filter(x => x.id !== subId);
      saveModel(); render();
    }

    function addSection(macroId, subId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      if(!sb) return;
      if(!Array.isArray(sb.sections)) sb.sections = [];
      sb.sections.push({ id: "s_" + uid(), title: "Nuevo proceso", tasks: ["Nueva tarea"] });
      saveModel(); render();
    }

    function deleteSection(macroId, subId, sectionId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      if(!sb) return;
      sb.sections = (sb.sections || []).filter(x => x.id !== sectionId);
      saveModel(); render();
    }

    function addTask(macroId, subId, sectionId){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec) return;
      if(!Array.isArray(sec.tasks)) sec.tasks = [];
      sec.tasks.push("Nueva tarea");
      saveModel(); render();
    }

    function deleteTask(macroId, subId, sectionId, idx){
      const m = model.macros.find(x => x.id === macroId);
      if(!m) return;
      const sb = (m.subprocesses || []).find(x => x.id === subId);
      const sec = sb ? (sb.sections || []).find(x => x.id === sectionId) : null;
      if(!sec || !Array.isArray(sec.tasks)) return;
      sec.tasks.splice(idx, 1);
      saveModel(); render();
    }

    // ===== Agregar / Eliminar BLOQUE (macro) con color distinto =====
    function addMacro(){
      const used = getUsedMacroClasses();
      const cls = pickClass(MACRO_PALETTE, used);

      const newId = "m_" + uid();

      // Subproceso inicial también con color distinto dentro de ese macro
      const spCls = pickClass(SUBPROC_PALETTE, new Set());

      model.macros.push({
        id: newId,
        className: cls,
        title: "Nuevo Bloque",
        desc: "Descripción del bloque",
        subprocesses: [
          {
            id: "sb_" + uid(),
            className: spCls,
            title: "Subproceso",
            sections: [{ id: "s_" + uid(), title: "Proceso", tasks: ["Tarea"] }]
          }
        ]
      });

      saveModel(); render();
    }

    function deleteMacroById(macroId){
      if(!macroId) return;
      if(model.macros.length <= 1){
        alert("No puedes eliminar el último bloque.");
        return;
      }
      model.macros = model.macros.filter(m => m.id !== macroId);
      saveModel(); render();
    }

    document.getElementById("addMacro").addEventListener("click", addMacro);
    document.getElementById("deleteMacro").addEventListener("click", () => {
      const last = model.macros[model.macros.length - 1];
      deleteMacroById(last?.id);
    });

    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest?.("button[data-action]");
      if(!btn) return;

      const a = btn.getAttribute("data-action");
      const macroId = btn.getAttribute("data-macro");
      const subId = btn.getAttribute("data-sub");
      const sectionId = btn.getAttribute("data-section");
      const taskIdx = btn.getAttribute("data-task");

      if(a === "addSubprocess") addSubprocess(macroId);
      if(a === "deleteSubprocess") deleteSubprocess(macroId, subId);
      if(a === "addSection") addSection(macroId, subId);
      if(a === "deleteSection") deleteSection(macroId, subId, sectionId);
      if(a === "addTask") addTask(macroId, subId, sectionId);
      if(a === "deleteTask") deleteTask(macroId, subId, sectionId, Number(taskIdx));
      if(a === "deleteMacroInline") deleteMacroById(macroId);
    });

    // ===== Drag & Drop: reordenar subprocesos =====
    function wireDnDAllMacros(){
      (model.macros || []).forEach(m => {
        const container = document.querySelector(`.subflow[data-subflow="${CSS.escape(m.id)}"]`);
        if(!container) return;

        let draggedId = null;

        const items = Array.from(container.querySelectorAll('.subblock[draggable="true"]'));
        items.forEach(el => {
          const handle = el.querySelector('.drag-handle');
          if(handle){
            handle.addEventListener('mousedown', () => el.dataset.dragAllowed = "1");
            handle.addEventListener('mouseup',   () => el.dataset.dragAllowed = "0");
            handle.addEventListener('mouseleave',() => el.dataset.dragAllowed = "0");
          }

          el.addEventListener('dragstart', (e) => {
            if(el.dataset.dragAllowed !== "1"){ e.preventDefault(); return; }
            draggedId = el.getAttribute('data-sub');
            el.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            try{ e.dataTransfer.setData('text/plain', draggedId); }catch(_){}
          });

          el.addEventListener('dragend', () => {
            el.classList.remove('dragging');
            el.dataset.dragAllowed = "0";
          });
        });

        container.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });

        container.addEventListener('drop', (e) => {
          e.preventDefault();
          const target = e.target.closest('.subblock');
          if(!target) return;

          const toId = target.getAttribute('data-sub');
          const fromId = draggedId || (()=>{
            try{ return e.dataTransfer.getData('text/plain'); }catch(_){ return null; }
          })();

          if(!fromId || !toId || fromId === toId) return;

          const mm = model.macros.find(x => x.id === m.id);
          if(!mm || !Array.isArray(mm.subprocesses)) return;

          const fromIndex = mm.subprocesses.findIndex(x => x.id === fromId);
          const toIndex   = mm.subprocesses.findIndex(x => x.id === toId);
          if(fromIndex < 0 || toIndex < 0) return;

          const [moved] = mm.subprocesses.splice(fromIndex, 1);
          mm.subprocesses.splice(toIndex, 0, moved);

          saveModel(); render();
        });
      });
    }

    // ===== Filtro =====
    function applyFilter(){
      const term = (q.value || "").trim().toLowerCase();
      const macrosEls = Array.from(document.querySelectorAll(".macro"));
      const connectors = Array.from(document.querySelectorAll(".connector"));

      if(!term){
        macrosEls.forEach(m => m.classList.remove("hide"));
        connectors.forEach(c => c.classList.remove("hide"));
        return;
      }

      macrosEls.forEach(m => {
        const hit = (m.innerText || m.textContent || "").toLowerCase().includes(term);
        m.classList.toggle("hide", !hit);
      });

      connectors.forEach((c, idx) => {
        const left = macrosEls[idx];
        const right = macrosEls[idx+1];
        const hide = (!left || left.classList.contains("hide")) || (!right || right.classList.contains("hide"));
        c.classList.toggle("hide", hide);
      });
    }
    q.addEventListener("input", applyFilter);

    // ===== Export =====
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function setExporting(on){ document.body.classList.toggle("exporting", !!on); }

    function getDeviceScale(){
      const dpr = window.devicePixelRatio || 1;
      return Math.min(4, Math.max(2, dpr * 2));
    }

    async function captureFullCanvas(){
      if(typeof html2canvas !== "function"){
        alert("No se cargó html2canvas (revisa conexión a internet o políticas del navegador).");
        return null;
      }

      setExporting(true);
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      const el = captureArea;
      const width = el.scrollWidth;
      const height = el.scrollHeight;
      const scale = getDeviceScale();

      const canvas = await html2canvas(el, {
        scale,
        backgroundColor: "#f4f7f6",
        useCORS: true,
        width,
        height,
        windowWidth: width,
        windowHeight: height,
        scrollX: 0,
        scrollY: 0,
        logging: false
      });

      setExporting(false);
      return canvas;
    }

    document.getElementById("exportHtml").addEventListener("click", () => {
      const clone = document.documentElement.cloneNode(true);
      const script = clone.querySelector("#INITIAL_MODEL");
      script.textContent = "\n" + JSON.stringify(model, null, 2) + "\n";
      const html = "<!doctype html>\n" + clone.outerHTML;
      downloadBlob(new Blob([html], {type:"text/html;charset=utf-8"}), "flujo_macro_editable.html");
    });

    document.getElementById("exportPng").addEventListener("click", async () => {
      const canvas = await captureFullCanvas();
      if(!canvas) return;
      canvas.toBlob((blob) => {
        if(!blob) return;
        downloadBlob(blob, "flujo_hd.png");
      }, "image/png");
    });

    document.getElementById("exportPdf").addEventListener("click", async () => {
      const canvas = await captureFullCanvas();
      if(!canvas) return;

      if(!window.jspdf?.jsPDF){
        alert("No se cargó jsPDF (revisa conexión a internet o políticas del navegador).");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation: "landscape", unit: "pt", format: "a4", compress: true});

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const scale = pageW / canvas.width;
      const pageCanvasHeight = Math.floor(pageH / scale);

      const tmp = document.createElement("canvas");
      const tctx = tmp.getContext("2d", {alpha: false});

      let y = 0;
      let page = 0;

      while(y < canvas.height){
        const sliceH = Math.min(pageCanvasHeight, canvas.height - y);
        tmp.width = canvas.width;
        tmp.height = sliceH;

        tctx.clearRect(0, 0, tmp.width, tmp.height);
        tctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

        const sliceData = tmp.toDataURL("image/png");
        if(page > 0) pdf.addPage();
        const drawH = sliceH * scale;

        pdf.addImage(sliceData, "PNG", 0, 0, pageW, drawH, undefined, "FAST");
        y += sliceH;
        page++;
      }

      pdf.save("flujo_hd.pdf");
    });

    document.getElementById("resetAll").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      model = loadDefault();
      saveModel();
      render();
    });

    // boot
    render();
  </script>



</body></html>
