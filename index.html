<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor de flujo â€” Vertical / Horizontal (BPMN-like)</title>
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --ink:#1f2d3d; --muted:#5b6775;
      --line:#2c3e50; --warn:#fef6e4;
      --shadow: 0 10px 30px rgba(0,0,0,.08); --radius: 12px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
    header{ padding:14px 16px; background:var(--card); box-shadow:var(--shadow); position:sticky; top:0; z-index:10;}
    header h1{ margin:0; font-size:15px; }
    header .row{ margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button{ border:1px solid #cfd6df; background:#fff; border-radius:10px; padding:7px 10px; font-size:12px; cursor:pointer; }
    button.primary{ background:var(--line); color:#fff; border-color:var(--line); }
    button.danger{ border-color:#b23b3b; color:#b23b3b; }
    .hint{ font-size:12px; color:var(--muted); margin-left:auto; }

    main{ padding:16px; }
    .wrap{ margin:0 auto; }

    /* ====== Canvas modes ====== */
    .canvas.vertical{
      max-width: 920px;
      margin: 0 auto;
    }
    .canvas.horizontal{
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 10px;
    }
    .track{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding: 0 6px;
      min-height: 160px;
    }

    /* ====== Nodes ====== */
    .node{
      background:#fff; border:2px solid var(--line); border-radius:10px;
      padding:10px 12px; margin:10px 0; position:relative; box-shadow:0 1px 0 rgba(0,0,0,.02);
      min-width: 260px;
    }
    .node.start,.node.end{ background:var(--line); color:#fff; font-weight:700; }
    .node.decision{ border-style:dashed; background:var(--warn); font-weight:700; }

    .text{ text-align:center; font-size:14px; line-height:1.25; padding:0 120px; }
    .note{ margin-top:6px; font-size:12px; color:var(--muted); font-weight:400; text-align:center; }
    .note span{ background:#eef2f6; padding:2px 8px; border-radius:999px; border:1px solid #d7dde5; }

    .controls{
      position:absolute; right:8px; top:8px; display:flex; gap:6px;
    }
    .controls button{ padding:4px 6px; font-size:12px; border-radius:9px; }
    .controls .chip{ border-color:#cfd6df; }
    .controls .del{ border-color:#b23b3b; color:#b23b3b; }

    .move{
      position:absolute; left:8px; top:8px; display:flex; gap:6px;
    }
    .move button{ padding:4px 6px; font-size:12px; border-radius:9px; }

    /* ====== Arrows ====== */
    .arrowV{ text-align:center; font-size:18px; color:var(--line); user-select:none; margin:4px 0; }
    .arrowH{
      display:flex; align-items:center; justify-content:center;
      font-size:18px; color:var(--line); user-select:none;
      min-width: 36px; height: 100%;
      margin-top: 18px;
    }

    /* ====== Decision BPMN-like in Horizontal ====== */
    .decisionGroup{
      display:grid;
      grid-template-columns: 220px 360px 120px;
      gap: 10px;
      align-items:center;          /* <- centramos todo verticalmente */
      padding-top: 8px;
      padding-bottom: 8px;
      min-width: 740px;
      position:relative;
    }

    .diamondWrap{
      position:relative;
      width: 220px;
      display:flex;
      align-items:center;          /* <- centrado respecto a ramas */
      justify-content:center;
      padding-top: 0;              /* <- antes 16px */
    }

    .diamond{
      width: 140px;
      height: 140px;
      background: var(--warn);
      border: 2px dashed var(--line);
      transform: rotate(45deg);
      border-radius: 12px;
      position: relative;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      cursor: pointer;
    }
    .diamond .label{
      position:absolute;
      inset: 16px;
      transform: rotate(-45deg);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:800;
      font-size:13px;
      color: var(--ink);
      padding: 0 10px;
      line-height:1.2;
    }

    .diamond .dControls{
      position:absolute;
      right:-6px;
      top:-10px;
      transform: rotate(-45deg);
      display:flex;
      gap:6px;
    }
    .diamond .dControls button{
      transform: rotate(0deg);
      padding:4px 6px;
      font-size:12px;
      border-radius:9px;
      border:1px solid #cfd6df;
      background:#fff;
      cursor:pointer;
    }
    .diamond .dControls .del{ border-color:#b23b3b; color:#b23b3b; }
    .diamond .dControls .chip{ border-color:#cfd6df; }

    .branchLane{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top: 0;              /* <- sin offset raro */
    }
    .branchRow{
      display:grid;
      grid-template-columns: 38px 1fr;
      gap:8px;
      align-items:stretch;
    }
    .branchArrow{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:var(--line);
      user-select:none;
      margin-top: 12px;
    }
    .branchCard{
      border:1px solid #d7dde5;
      background:#fff;
      border-radius:10px;
      padding:10px;
      position:relative;
    }
    .branchCard h3{
      margin:0 0 8px 0;
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .branchCard h3 .lbl{ font-weight:900; }
    .branchCard h3 .bBtns{ margin-left:auto; display:flex; gap:6px; }
    .branchCard h3 .bBtns button{
      padding:3px 6px; border-radius:9px; font-size:12px; border:1px solid #cfd6df; background:#fff; cursor:pointer;
    }
    .branchCard h3 .bBtns .del{ border-color:#b23b3b; color:#b23b3b; }

    .item{
      border:1px solid #d7dde5;
      border-radius:10px;
      padding:8px;
      margin:8px 0;
      position:relative;
      background:#fff;
    }
    .item .itemText{ font-size:13px; text-align:left; padding-right:74px; }
    .item .itemControls{ position:absolute; right:8px; top:8px; display:flex; gap:6px; }
    .item .itemControls button{
      padding:3px 6px; border-radius:9px; font-size:12px; border:1px solid #cfd6df; background:#fff; cursor:pointer;
    }
    .item .itemControls .del{ border-color:#b23b3b; color:#b23b3b; }
    .item .itemControls .add{ border-color:#2c3e50; color:#2c3e50; font-weight:800; }

    .addInBranch{
      width:100%;
      padding:7px 10px;
      border-style:dashed;
      margin-top:6px;
      border-radius:10px;
      cursor:pointer;
      background:#fff;
    }

    .mergeWrap{
      display:flex;
      align-items:center;          /* <- centramos merge */
      justify-content:center;
      padding-top: 0;              /* <- antes 58px */
      width: 120px;
    }
    .mergeNode{
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: 2px solid var(--line);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:var(--line);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      user-select:none;
    }
    .mergeHint{
      font-size:11px;
      color:var(--muted);
      text-align:center;
      margin-top: 6px;
    }

    /* ====== Vertical decision layout ====== */
    .branchesV{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px;
    }
    @media (max-width: 880px){ .branchesV{ grid-template-columns: 1fr; } }

    .decisionTools{
      display:flex; gap:8px; margin-top:10px; justify-content:center;
    }
    .decisionTools button{ padding:6px 10px; border-style:dashed; border-radius:10px; background:#fff; cursor:pointer; }

    /* ====== Modal ====== */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:50;
      align-items:center; justify-content:center; padding:16px;
    }
    .modal .card{
      width:min(560px, 100%); background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:14px;
    }
    .modal label{ font-size:12px; color:var(--muted); display:block; margin-top:8px; }
    .modal input{
      width:100%; margin-top:6px; border:1px solid #d7dde5; border-radius:10px; padding:10px;
      font-size:13px; font-family:inherit; outline:none;
    }
    .modal .row{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end; }
  </style>
</head>

<body>
<header>
  <h1>Editor directo del flujo â€” Vertical / Horizontal (Horizontal BPMN-like)</h1>
  <div class="row">
    <button class="primary" id="btnToggle">Vista: Vertical</button>
    <button class="primary" id="btnAddStepTop">+ STEP al inicio</button>
    <button class="primary" id="btnAddDecisionTop">+ DECISION al inicio</button>
    <button id="btnExport">Exportar JSON</button>
    <button id="btnImport">Importar JSON</button>
    <button class="danger" id="btnReset">Restaurar v1</button>
    <div class="hint">Doble clic = editar â€¢ +STEP/+DEC â€¢ +BRANCH dentro de DECISION</div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="canvas" class="canvas vertical"></div>
  </div>
</main>

<div class="modal" id="modal">
  <div class="card">
    <div style="font-weight:800;">Editar</div>
    <label>Texto</label>
    <input id="mText" type="text" />
    <label>Nota (opcional)</label>
    <input id="mNote" type="text" placeholder="Ej: (solo subcontrato)" />
    <div class="row">
      <button id="mCancel">Cancelar</button>
      <button class="primary" id="mOk">Guardar</button>
    </div>
  </div>
</div>

<script>
  const STORE_KEY = "flujo_editor_vh_bpmnlike_model";
  const VIEW_KEY  = "flujo_editor_vh_bpmnlike_view";

  const DEFAULT_MODEL = {
    nodes: [
      { type:"start", text:"INICIO" },
      {
        type:"decision",
        text:"Origen del trabajador",
        branches:[
          { label:"SelecciÃ³n", items:[{ text:"DerivaciÃ³n desde proceso de selecciÃ³n" }] },
          { label:"Onboarding", items:[{ text:"DerivaciÃ³n desde onboarding" }] },
          { label:"Obra Directivo", items:[{ text:"Ingreso directo desde obra (directivo)" }] },
          { label:"Obra Operario", items:[{ text:"Ingreso directo desde obra (operario)" }] }
        ]
      },
      { type:"step", text:"Alta administrativa trabajador en EESS" },
      { type:"step", text:"Ingreso datos personales" },
      { type:"step", text:"Ingreso datos contractuales" },
      { type:"step", text:"DefiniciÃ³n estructura organizacional" },
      { type:"step", text:"AsignaciÃ³n centro de costo" },
      { type:"step", text:"Carga documentaciÃ³n laboral" },
      { type:"step", text:"Habilitar app / reloj de marcaje" },
      { type:"step", text:"Sincronizar usuarios", note:"(solo subcontrato)" },
      { type:"step", text:"Activar portal de asistencia" },
      { type:"step", text:"Registro diario de asistencia" },
      { type:"step", text:"Horas extras", note:"(registro asociado a asistencia)" },
      { type:"step", text:"Faltas", note:"(registro asociado a asistencia)" },
      { type:"step", text:"Vacaciones", note:"(registro asociado a asistencia)" },
      { type:"step", text:"Licencias", note:"(registro asociado a asistencia)" },
      { type:"step", text:"Permisos", note:"(registro asociado a asistencia)" },
      { type:"step", text:"ConsolidaciÃ³n asistencia mensual" },
      { type:"step", text:"Traspaso asistencia a remuneraciones", note:"(HE + faltas)" },
      { type:"step", text:"Ingreso haber movilizaciÃ³n" },
      { type:"step", text:"Ingreso haberes y descuentos mensuales" },
      { type:"step", text:"Ingreso prÃ©stamos" },
      { type:"step", text:"Ingreso sobregiros" },
      { type:"step", text:"Ingreso otros descuentos / seguros" },
      { type:"step", text:"Pago anticipo" },
      { type:"step", text:"Pago sueldo" },
      { type:"step", text:"Pago ajustes" },
      {
        type:"decision",
        text:"Â¿Existe finiquito?",
        branches:[
          { label:"NO", items:[{ text:"(continÃºa sin finiquito)" }] },
          { label:"SÃ", items:[
            { text:"SimulaciÃ³n datos carta finiquito" },
            { text:"Grabar data finiquito" },
            { text:"ImpresiÃ³n documentos" },
            { text:"Finiquito aplicado", note:"(fin de mes)" }
          ]}
        ]
      },
      { type:"step", text:"DefiniciÃ³n medio de pago" },
      { type:"step", text:"Transferencias bancarias", note:"(por empresa / por banco)" },
      { type:"step", text:"Generar prueba ingreso ficha" },
      { type:"step", text:"Informes de gestiÃ³n" },
      { type:"step", text:"INE" },
      { type:"step", text:"LRE" },
      { type:"step", text:"Leyes sociales" },
      { type:"end", text:"CIERRE MENSUAL" }
    ]
  };

  let model = loadModel() ?? structuredClone(DEFAULT_MODEL);
  let viewMode = localStorage.getItem(VIEW_KEY) || "vertical";

  const canvas = document.getElementById("canvas");
  const modal = document.getElementById("modal");
  const mText = document.getElementById("mText");
  const mNote = document.getElementById("mNote");
  let modalCtx = null;

  function openModal(ctx, text, note){
    modalCtx = ctx;
    mText.value = text ?? "";
    mNote.value = note ?? "";
    modal.style.display = "flex";
    mText.focus();
  }
  function closeModal(){ modal.style.display = "none"; modalCtx = null; }

  document.getElementById("mCancel").onclick = closeModal;
  document.getElementById("mOk").onclick = () => {
    if(!modalCtx) return closeModal();
    const newText = mText.value.trim() || "(sin texto)";
    const newNote = mNote.value.trim();

    if(modalCtx.kind === "node"){
      const n = model.nodes[modalCtx.nodeIndex];
      n.text = newText;
      if(newNote) n.note = newNote; else delete n.note;
    }else if(modalCtx.kind === "branch"){
      const d = model.nodes[modalCtx.nodeIndex];
      d.branches[modalCtx.branchIndex].label = newText;
    }else{
      const d = model.nodes[modalCtx.nodeIndex];
      const item = d.branches[modalCtx.branchIndex].items[modalCtx.itemIndex];
      item.text = newText;
      if(newNote) item.note = newNote; else delete item.note;
    }
    saveModel(); render(); closeModal();
  };

  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modal.style.display==="flex") closeModal(); });

  function btn(label, onClick, cls){
    const b = document.createElement("button");
    if(cls) b.className = cls;
    b.textContent = label;
    b.onclick = (e)=>{ e.stopPropagation(); onClick(); };
    return b;
  }

  function setView(mode){
    viewMode = mode;
    localStorage.setItem(VIEW_KEY, viewMode);
    document.getElementById("btnToggle").textContent = "Vista: " + (viewMode === "vertical" ? "Vertical" : "Horizontal");
    render();
  }

  function render(){
    canvas.className = "canvas " + viewMode;
    canvas.innerHTML = "";

    if(viewMode === "horizontal"){
      const track = document.createElement("div");
      track.className = "track";

      model.nodes.forEach((n, idx) => {
        if(n.type === "decision"){
          track.appendChild(renderDecisionHorizontal(n, idx));
        }else{
          track.appendChild(renderNodeLinear(n, idx, true));
        }

        if(idx < model.nodes.length - 1){
          const arr = document.createElement("div");
          arr.className = "arrowH";
          arr.textContent = "â†’";
          track.appendChild(arr);
        }
      });

      canvas.appendChild(track);
    }else{
      model.nodes.forEach((n, idx) => {
        canvas.appendChild(renderNodeVertical(n, idx));
        if(idx < model.nodes.length - 1){
          const arr = document.createElement("div");
          arr.className = "arrowV";
          arr.textContent = "â†“";
          canvas.appendChild(arr);
        }
      });
    }
  }

  function renderNodeLinear(n, idx, isHorizontal){
    const el = document.createElement("div");
    el.className = "node " + (n.type || "step");

    const text = document.createElement("div");
    text.className = "text";
    text.style.padding = isHorizontal ? "0 84px" : "0 120px";
    text.textContent = n.text || "(sin texto)";
    el.appendChild(text);

    if(n.note){
      const note = document.createElement("div");
      note.className = "note";
      const pill = document.createElement("span");
      pill.textContent = n.note;
      note.appendChild(pill);
      el.appendChild(note);
    }

    const move = document.createElement("div");
    move.className = "move";
    if(n.type !== "start" && n.type !== "end"){
      move.appendChild(btn("â†‘", ()=>moveNode(idx,-1)));
      move.appendChild(btn("â†“", ()=>moveNode(idx,+1)));
    }
    el.appendChild(move);

    const controls = document.createElement("div");
    controls.className = "controls";
    if(n.type !== "end"){
      controls.appendChild(btn("+STEP", ()=>addNodeAfter(idx,"step"), "chip"));
      controls.appendChild(btn("+DEC", ()=>addNodeAfter(idx,"decision"), "chip"));
    }
    if(n.type !== "start" && n.type !== "end"){
      controls.appendChild(btn("ðŸ—‘", ()=>deleteNode(idx), "del"));
    }
    el.appendChild(controls);

    el.ondblclick = ()=>openModal({kind:"node", nodeIndex: idx}, n.text, n.note);

    return el;
  }

  function renderNodeVertical(n, idx){
    if(n.type !== "decision"){
      return renderNodeLinear(n, idx, false);
    }

    const el = document.createElement("div");
    el.className = "node decision";

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = n.text || "(sin texto)";
    el.appendChild(text);

    const move = document.createElement("div");
    move.className = "move";
    move.appendChild(btn("â†‘", ()=>moveNode(idx,-1)));
    move.appendChild(btn("â†“", ()=>moveNode(idx,+1)));
    el.appendChild(move);

    const controls = document.createElement("div");
    controls.className = "controls";
    controls.appendChild(btn("+STEP", ()=>addNodeAfter(idx,"step"), "chip"));
    controls.appendChild(btn("+DEC", ()=>addNodeAfter(idx,"decision"), "chip"));
    controls.appendChild(btn("ðŸ—‘", ()=>deleteNode(idx), "del"));
    el.appendChild(controls);

    el.ondblclick = ()=>openModal({kind:"node", nodeIndex: idx}, n.text, n.note);

    const branches = document.createElement("div");
    branches.className = "branchesV";

    (n.branches || []).forEach((b, bIdx)=>{
      const br = document.createElement("div");
      br.className = "branchCard";

      const h = document.createElement("h3");
      const lbl = document.createElement("span");
      lbl.className = "lbl";
      lbl.textContent = b.label || "Rama";
      h.appendChild(lbl);

      const bBtns = document.createElement("span");
      bBtns.className = "bBtns";
      bBtns.appendChild(btn("Editar", ()=>openModal({kind:"branch", nodeIndex: idx, branchIndex: bIdx}, b.label, "")));
      bBtns.appendChild(btn("ðŸ—‘", ()=>delBranch(idx, bIdx), "del"));
      h.appendChild(bBtns);

      br.appendChild(h);

      (b.items || []).forEach((it, itIdx)=>{
        const item = document.createElement("div");
        item.className = "item";
        const t = document.createElement("div");
        t.className = "itemText";
        t.textContent = it.text || "(sin texto)";
        item.appendChild(t);

        if(it.note){
          const nn = document.createElement("div");
          nn.className = "note";
          nn.style.textAlign = "left";
          const pill = document.createElement("span");
          pill.textContent = it.note;
          nn.appendChild(pill);
          item.appendChild(nn);
        }

        const ic = document.createElement("div");
        ic.className = "itemControls";
        ic.appendChild(btn("+", ()=>addBranchItem(idx, bIdx, itIdx), "add"));
        ic.appendChild(btn("ðŸ—‘", ()=>delBranchItem(idx, bIdx, itIdx), "del"));
        item.appendChild(ic);

        item.ondblclick = ()=>openModal({kind:"branchItem", nodeIndex: idx, branchIndex: bIdx, itemIndex: itIdx}, it.text, it.note);

        br.appendChild(item);
      });

      const addBtn = document.createElement("button");
      addBtn.className = "addInBranch";
      addBtn.textContent = "+ Agregar STEP en rama";
      addBtn.onclick = ()=>addBranchItem(idx, bIdx, (b.items?.length ?? 0) - 1);
      br.appendChild(addBtn);

      branches.appendChild(br);
    });

    el.appendChild(branches);

    const tools = document.createElement("div");
    tools.className = "decisionTools";
    tools.appendChild(btn("+ BRANCH", ()=>addBranch(idx), ""));
    el.appendChild(tools);

    return el;
  }

  function renderDecisionHorizontal(n, idx){
    const group = document.createElement("div");
    group.className = "decisionGroup";

    // Columna izquierda: rombo
    const left = document.createElement("div");
    left.className = "diamondWrap";

    const diamond = document.createElement("div");
    diamond.className = "diamond";

    const label = document.createElement("div");
    label.className = "label";
    label.textContent = n.text || "(sin texto)";
    diamond.appendChild(label);

    const dControls = document.createElement("div");
    dControls.className = "dControls";
    dControls.appendChild(btn("+STEP", ()=>addNodeAfter(idx,"step"), "chip"));
    dControls.appendChild(btn("+DEC", ()=>addNodeAfter(idx,"decision"), "chip"));
    dControls.appendChild(btn("ðŸ—‘", ()=>deleteNode(idx), "del"));
    diamond.appendChild(dControls);

    diamond.ondblclick = ()=>openModal({kind:"node", nodeIndex: idx}, n.text, n.note);

    left.appendChild(diamond);
    group.appendChild(left);

    // Columna central: ramas
    const mid = document.createElement("div");
    mid.className = "branchLane";

    (n.branches || []).forEach((b, bIdx)=>{
      const row = document.createElement("div");
      row.className = "branchRow";

      const arr = document.createElement("div");
      arr.className = "branchArrow";
      arr.textContent = "â†˜";
      row.appendChild(arr);

      const card = document.createElement("div");
      card.className = "branchCard";

      const h = document.createElement("h3");
      const lbl = document.createElement("span");
      lbl.className = "lbl";
      lbl.textContent = b.label || "Rama";
      h.appendChild(lbl);

      const bBtns = document.createElement("span");
      bBtns.className = "bBtns";
      bBtns.appendChild(btn("Editar", ()=>openModal({kind:"branch", nodeIndex: idx, branchIndex: bIdx}, b.label, "")));
      bBtns.appendChild(btn("ðŸ—‘", ()=>delBranch(idx, bIdx), "del"));
      h.appendChild(bBtns);

      card.appendChild(h);

      (b.items || []).forEach((it, itIdx)=>{
        const item = document.createElement("div");
        item.className = "item";

        const t = document.createElement("div");
        t.className = "itemText";
        t.textContent = it.text || "(sin texto)";
        item.appendChild(t);

        if(it.note){
          const nn = document.createElement("div");
          nn.className = "note";
          nn.style.textAlign = "left";
          const pill = document.createElement("span");
          pill.textContent = it.note;
          nn.appendChild(pill);
          item.appendChild(nn);
        }

        const ic = document.createElement("div");
        ic.className = "itemControls";
        ic.appendChild(btn("+", ()=>addBranchItem(idx, bIdx, itIdx), "add"));
        ic.appendChild(btn("ðŸ—‘", ()=>delBranchItem(idx, bIdx, itIdx), "del"));
        item.appendChild(ic);

        item.ondblclick = ()=>openModal({kind:"branchItem", nodeIndex: idx, branchIndex: bIdx, itemIndex: itIdx}, it.text, it.note);

        card.appendChild(item);
      });

      const addBtn = document.createElement("button");
      addBtn.className = "addInBranch";
      addBtn.textContent = "+ Agregar STEP en rama";
      addBtn.onclick = ()=>addBranchItem(idx, bIdx, (b.items?.length ?? 0) - 1);
      card.appendChild(addBtn);

      row.appendChild(card);
      mid.appendChild(row);
    });

    const addBranchBtn = document.createElement("div");
    addBranchBtn.className = "decisionTools";
    addBranchBtn.appendChild(btn("+ BRANCH", ()=>addBranch(idx), ""));
    mid.appendChild(addBranchBtn);

    group.appendChild(mid);

    // Columna derecha: merge
    const right = document.createElement("div");
    right.className = "mergeWrap";

    const mergeCol = document.createElement("div");
    mergeCol.style.display = "flex";
    mergeCol.style.flexDirection = "column";
    mergeCol.style.alignItems = "center";

    const merge = document.createElement("div");
    merge.className = "mergeNode";
    merge.textContent = "â‹ˆ";
    mergeCol.appendChild(merge);

    const mh = document.createElement("div");
    mh.className = "mergeHint";
    mh.textContent = "converge";
    mergeCol.appendChild(mh);

    right.appendChild(mergeCol);
    group.appendChild(right);

    // Botones de mover decisiÃ³n completa
    const mover = document.createElement("div");
    mover.style.position = "absolute";
    mover.style.left = "6px";
    mover.style.top = "-4px";
    mover.style.display = "flex";
    mover.style.gap = "6px";

    const up = btn("â†‘", ()=>moveNode(idx,-1));
    const down = btn("â†“", ()=>moveNode(idx,+1));
    up.style.padding = "4px 6px"; down.style.padding = "4px 6px";
    up.style.borderRadius = "9px"; down.style.borderRadius = "9px";
    mover.appendChild(up); mover.appendChild(down);

    group.appendChild(mover);

    return group;
  }

  // Ops
  function addNodeAfter(index, kind){
    if(kind === "step"){
      model.nodes.splice(index+1, 0, {type:"step", text:"Nueva actividad"});
    }else{
      model.nodes.splice(index+1, 0, {
        type:"decision",
        text:"Nueva decisiÃ³n",
        branches:[
          { label:"OpciÃ³n A", items:[{text:"Paso A1"}] },
          { label:"OpciÃ³n B", items:[{text:"Paso B1"}] }
        ]
      });
    }
    saveModel(); render();
  }

  function deleteNode(index){
    const n = model.nodes[index];
    if(n.type === "decision"){
      if(!confirm("Eliminar DECISIÃ“N completa con sus ramas. Â¿Continuar?")) return;
    }
    model.nodes.splice(index,1);
    saveModel(); render();
  }

  function moveNode(index, delta){
    const newIndex = index + delta;
    if(newIndex < 0 || newIndex >= model.nodes.length) return;
    if(model.nodes[index].type === "start" || model.nodes[index].type === "end") return;
    if(model.nodes[newIndex].type === "start" || model.nodes[newIndex].type === "end") return;
    const [it] = model.nodes.splice(index,1);
    model.nodes.splice(newIndex,0,it);
    saveModel(); render();
  }

  function addBranch(nodeIndex){
    const d = model.nodes[nodeIndex];
    if(!d.branches) d.branches = [];
    d.branches.push({ label:"Nueva rama", items:[{text:"Nuevo STEP"}] });
    saveModel(); render();
  }
  function delBranch(nodeIndex, branchIndex){
    const d = model.nodes[nodeIndex];
    if((d.branches?.length ?? 0) <= 1){ alert("Una decisiÃ³n debe tener al menos 1 rama."); return; }
    d.branches.splice(branchIndex,1);
    saveModel(); render();
  }
  function addBranchItem(nodeIndex, branchIndex, afterIndex){
    const d = model.nodes[nodeIndex];
    const b = d.branches[branchIndex];
    if(!b.items) b.items = [];
    const at = Math.max(0, (afterIndex ?? -1) + 1);
    b.items.splice(at, 0, {text:"Nuevo STEP (rama)"});
    saveModel(); render();
  }
  function delBranchItem(nodeIndex, branchIndex, itemIndex){
    const d = model.nodes[nodeIndex];
    d.branches[branchIndex].items.splice(itemIndex,1);
    saveModel(); render();
  }

  function saveModel(){ localStorage.setItem(STORE_KEY, JSON.stringify(model)); }
  function loadModel(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  // Botones
  document.getElementById("btnToggle").onclick = ()=>{
    setView(viewMode === "vertical" ? "horizontal" : "vertical");
  };

  document.getElementById("btnAddStepTop").onclick = ()=>{
    model.nodes.splice(1,0,{type:"step", text:"Nueva actividad"});
    saveModel(); render();
  };
  document.getElementById("btnAddDecisionTop").onclick = ()=>{
    model.nodes.splice(1,0,{
      type:"decision",
      text:"Nueva decisiÃ³n",
      branches:[{label:"OpciÃ³n A", items:[{text:"Paso A1"}]},{label:"OpciÃ³n B", items:[{text:"Paso B1"}]}]
    });
    saveModel(); render();
  };

  document.getElementById("btnReset").onclick = ()=>{
    if(!confirm("Restaurar el flujo v1 y perder cambios actuales. Â¿Continuar?")) return;
    model = structuredClone(DEFAULT_MODEL);
    saveModel(); render();
  };

  document.getElementById("btnExport").onclick = async ()=>{
    const txt = JSON.stringify(model, null, 2);
    try{ await navigator.clipboard.writeText(txt); alert("JSON copiado al portapapeles."); }
    catch{ prompt("Copia este JSON:", txt); }
  };

  document.getElementById("btnImport").onclick = ()=>{
    const txt = prompt("Pega aquÃ­ el JSON exportado:");
    if(!txt) return;
    try{
      const obj = JSON.parse(txt);
      if(!obj || !Array.isArray(obj.nodes)) throw new Error("Estructura invÃ¡lida");
      model = obj;
      saveModel(); render();
      alert("Importado OK.");
    }catch(e){
      alert("No pude importar. Revisa el JSON.\n\nDetalle: " + (e.message || e));
    }
  };

  document.getElementById("btnToggle").textContent = "Vista: " + (viewMode === "vertical" ? "Vertical" : "Horizontal");
  canvas.className = "canvas " + viewMode;
  render();
</script>
</body>
</html>
